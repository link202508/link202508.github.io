<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover"
  />
  <title>Document</title>
  <script src="./jsQR.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="./scan.css">
</head>

<body>
  <button id="start-btn">å¼€å§‹å¹¿è§’æ‰«ç 2</button>
  <button id="test-photo-btn" style="margin-left: 10px; padding: 10px 20px; background: #ffc107; color: black; border: none; border-radius: 5px; cursor: pointer;">æµ‹è¯•æ‹ç…§</button>

  <div class="reader-wrap">
    <div style="position: relative;width: 160px;height: 160px;">
      <canvas id="reader-canvas">
      </canvas>
      <div class="scan-box">
        <div class="line"></div>
        <div class="angle"></div>
      </div>
      <div class="loading-wrap">
        <svg class="circular" viewBox="0 0 20 20">
          <g class="path2 loading-path" stroke-width="0" style="animation: none; stroke: none">
            <circle r="3.375" class="dot1" rx="0" ry="0" />
            <circle r="3.375" class="dot2" rx="0" ry="0" />
            <circle r="3.375" class="dot4" rx="0" ry="0" />
            <circle r="3.375" class="dot3" rx="0" ry="0" />
          </g>
        </svg>
        <div>æ­£åœ¨åˆå§‹åŒ–...</div>
      </div>
      <div class="outputMessage"></div>
    </div>
  </div>

  <!-- æ‹ç…§ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
  <div id="photo-result" style="display: none; margin-top: 20px; text-align: center;">
    <h3>æ‹ç…§ç»“æœ</h3>
    <img id="captured-photo" style="max-width: 100%; max-height: 400px; border: 2px solid #ccc; border-radius: 10px;" />
    <div style="margin-top: 10px;">
      <button id="save-photo-btn" style="padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">ä¿å­˜å›¾ç‰‡</button>
      <button id="restart-scan-btn" style="padding: 10px 20px; margin: 5px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">é‡æ–°æ‰«æ</button>
    </div>
    <textarea id="base64-output" placeholder="Base64 å›¾ç‰‡æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." style="width: 100%; height: 100px; margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical;"></textarea>
  </div>

  <script>
    const canvasEle = document.querySelector('#reader-canvas')
    const canvasCtx = canvasEle.getContext('2d', {
      willReadFrequently: true,
    })
    let stream = null
    let video = null
    let isScanning = false
    /** äºŒç»´ç é¢ç§¯å æ¯”é™åˆ¶, åªæœ‰å æ¯”å°äºè¿™ä¸ªå€¼çš„äºŒç»´ç æ‰ä¼šè¢«æ‰«æï¼Œ æœ€å¤§å€¼ä¸º1 */
    const RatioLimit = 0.03

    document.getElementById('start-btn').addEventListener('click', () => {
      startScan()
    })

    // æµ‹è¯•æ‹ç…§æŒ‰é’®äº‹ä»¶
    document.getElementById('test-photo-btn').addEventListener('click', () => {
      if (video && isScanning) {
        console.log('æ‰‹åŠ¨è§¦å‘æµ‹è¯•æ‹ç…§');
        capturePhoto();
      } else {
        message('è¯·å…ˆå¼€å§‹æ‰«æ');
      }
    })

    // ä¿å­˜å›¾ç‰‡æŒ‰é’®äº‹ä»¶
    document.getElementById('save-photo-btn').addEventListener('click', () => {
      downloadPhoto()
    })

    // é‡æ–°æ‰«ææŒ‰é’®äº‹ä»¶
    document.getElementById('restart-scan-btn').addEventListener('click', () => {
      hidePhotoResult()
      startScan()
    })

    /** åˆå§‹åŒ– */
    function startScan() {
      if (isScanning) return
      
      video = document.createElement("video");
      isScanning = true

      // æ˜¾ç¤ºåŠ è½½ä¸­åŠ¨ç”»
      showLoading()

      document.querySelector('.reader-wrap').style.display = 'flex'
      navigator.mediaDevices.getUserMedia({
        audio: false, // ä¸éœ€è¦éŸ³é¢‘
        video: {
          facingMode: "environment", // ä½¿ç”¨åç½®æ‘„åƒå¤´
          // ç§»é™¤å›ºå®šåˆ†è¾¨ç‡é™åˆ¶ï¼Œè®©æ‘„åƒå¤´ä½¿ç”¨å…¶åŸç”Ÿåˆ†è¾¨ç‡
          width: { min: 640, ideal: 1920, max: 4096 },
          height: { min: 480, ideal: 1080, max: 4096 }
        }
      }).then(function (videoStream) {
        stream = videoStream // ä¿å­˜æµå¼•ç”¨
        video.srcObject = videoStream;

        // è·å–è§†é¢‘è½¨é“å¹¶è®¾ç½®å¹¿è§’æ¨¡å¼
        const track = videoStream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        
        console.log('æ‘„åƒå¤´èƒ½åŠ›:', capabilities);
        
        // ç®€åŒ–çš„å¹¿è§’è®¾ç½®
        if (capabilities.zoom && capabilities.zoom.min) {
          track.applyConstraints({ 
            advanced: [{ zoom: capabilities.zoom.min }] 
          })
          .then(() => console.log('å¹¿è§’æ¨¡å¼è®¾ç½®æˆåŠŸ'))
          .catch(e => console.warn('å¹¿è§’è®¾ç½®å¤±è´¥:', e));
        }

        // è®© safari æµè§ˆå™¨ä¸è¿›å…¥å…¨å±
        video.setAttribute("playsinline", true);
        video.setAttribute('webkit-playsinline', 'true');

        video.play();
        requestAnimationFrame(renderVideo);
        hideLoading()
      })
        .catch(err => {
          console.error(err)
          message('æ‚¨éœ€è¦æˆäºˆç›¸æœºè®¿é—®æƒé™')
          isScanning = false
        })
    }

    /** æ‰«ææˆåŠŸå›è°ƒ */
    function onScanSuccess(decodedText, ratio) {
      console.log('æ‰«ææˆåŠŸ:', decodedText, 'é¢ç§¯æ¯”ä¾‹:', ratio)
      if (ratio > RatioLimit) {
        message('è¯·ç¦»è¿œä¸€ç‚¹')
        return
      }
      clearMessage()
      
      // ç«‹å³æ‹ç…§ - æ ¹æ®è§„èŒƒä¸è®¾ç½®å€’è®¡æ—¶
      message('æ‰«ææˆåŠŸï¼æ­£åœ¨ä½¿ç”¨å¹¿è§’æ¨¡å¼æ‹ç…§...')
      
      // çŸ­æš‚å»¶è¿Ÿä»¥ç¡®ä¿ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
      setTimeout(() => {
        capturePhoto()
        stopScan()
      }, 800) // ç¨å¾®å¢åŠ å»¶è¿Ÿä»¥è®©ç”¨æˆ·çœ‹åˆ°åé¦ˆ
    }

    function detectQRCodeFn() {
      const imageData = canvasCtx.getImageData(0, 0, canvasEle.width, canvasEle.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code) {
        // ç»˜åˆ¶è¾¹æ¡†
        drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
        drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");

        if (!validateQRCodeText(code.data)) {
          message('æ— æ•ˆçš„äºŒç»´ç ')
          return
        }

        const loc = code.location;
        // ä½¿ç”¨ Shoelace å…¬å¼è®¡ç®—ä»»æ„å››è¾¹å½¢é¢ç§¯ï¼Œæ›´ç²¾ç¡®
        const qrArea = 0.5 * Math.abs(
          loc.topLeftCorner.x * loc.topRightCorner.y - loc.topLeftCorner.y * loc.topRightCorner.x +
          loc.topRightCorner.x * loc.bottomRightCorner.y - loc.topRightCorner.y * loc.bottomRightCorner.x +
          loc.bottomRightCorner.x * loc.bottomLeftCorner.y - loc.bottomRightCorner.y * loc.bottomLeftCorner.x +
          loc.bottomLeftCorner.x * loc.topLeftCorner.y - loc.bottomLeftCorner.y * loc.topLeftCorner.x
        );

        const imageArea = canvasEle.width * canvasEle.height;
        const ratio = qrArea / imageArea;
        onScanSuccess(code.data, ratio)
      }
    }

    // æ¸²æŸ“è§†é¢‘åˆ° canvas
    function renderVideo() {
      if (video && video.readyState === video.HAVE_ENOUGH_DATA && isScanning) {
        canvasEle.height = video.videoHeight;
        canvasEle.width = video.videoWidth;
        canvasCtx.drawImage(video, 0, 0, canvasEle.width, canvasEle.height);
        detectQRCodeFn()
      }
      if (isScanning) {
        requestAnimationFrame(renderVideo);
      }
    }

    /** æ‹ç…§åŠŸèƒ½ - åŠ¨æ€åˆ‡æ¢åˆ°å¹¿è§’æ¨¡å¼ */
    function capturePhoto() {
      console.log('=== å¼€å§‹æ‹ç…§åŠŸèƒ½ï¼Œåˆ‡æ¢åˆ°å¹¿è§’æ¨¡å¼ ===');
      
      if (!video || !stream) {
        console.error('æ‘„åƒå¤´æœªå°±ç»ª');
        message('æ‘„åƒå¤´æœªå°±ç»ªï¼Œè¯·é‡æ–°æ‰«æ');
        return;
      }
      
      try {
        // è·å–å½“å‰è§†é¢‘è½¨é“
        const track = stream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        
        console.log('å¼€å§‹åº”ç”¨å¹¿è§’æ‹ç…§è®¾ç½®...');
        
        // æ„å»ºå¹¿è§’æ‹ç…§çº¦æŸ
        const photoConstraints = {
          advanced: []
        };
        
        // è®¾ç½®æœ€å°ç¼©æ”¾å€¼è·å¾—æœ€å¤§è§†é‡ï¼ˆå¹¿è§’æ•ˆæœï¼‰
        if (capabilities.zoom) {
          const minZoom = capabilities.zoom.min || 1;
          photoConstraints.advanced.push({ zoom: minZoom });
          console.log('è®¾ç½®å¹¿è§’ç¼©æ”¾å€¼:', minZoom);
        }
        
        // æ ¹æ®è§„èŒƒä½¿ç”¨æœ€é«˜åˆ†è¾¨ç‡ï¼Œä½†è€ƒè™‘å…¼å®¹æ€§é™åˆ¶
        if (capabilities.width && capabilities.height) {
          // åœ¨å…¼å®¹æ€§å’Œè§„èŒƒè¦æ±‚ä¹‹é—´æ‰¾å¹³è¡¡
          const maxWidth = Math.min(capabilities.width.max || 1920, 1920);
          const maxHeight = Math.min(capabilities.height.max || 1920, 1920);
          
          photoConstraints.advanced.push({
            width: { ideal: maxWidth },
            height: { ideal: maxHeight }
          });
          console.log('è®¾ç½®æ‹ç…§åˆ†è¾¨ç‡:', maxWidth + 'x' + maxHeight);
        }
        
        // åº”ç”¨å¹¿è§’æ‹ç…§è®¾ç½®
        if (photoConstraints.advanced.length > 0) {
          console.log('åº”ç”¨å¹¿è§’æ‹ç…§çº¦æŸ...');
          track.applyConstraints(photoConstraints)
            .then(() => {
              console.log('å¹¿è§’æ‹ç…§è®¾ç½®åº”ç”¨æˆåŠŸï¼Œç­‰å¾…ç”Ÿæ•ˆ...');
              // ç­‰å¾…è®¾ç½®ç”Ÿæ•ˆåè¿›è¡Œæ‹ç…§
              setTimeout(() => {
                performWideAngleCapture();
              }, 800); // å¢åŠ ç­‰å¾…æ—¶é—´ç¡®ä¿è®¾ç½®å®Œå…¨ç”Ÿæ•ˆ
            })
            .catch((error) => {
              console.warn('å¹¿è§’æ‹ç…§è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨å½“å‰è®¾ç½®:', error);
              performWideAngleCapture();
            });
        } else {
          console.log('è®¾å¤‡ä¸æ”¯æŒåŠ¨æ€è®¾ç½®ï¼Œç›´æ¥æ‹ç…§');
          performWideAngleCapture();
        }
        
      } catch (error) {
        console.error('æ‹ç…§åˆå§‹åŒ–å¤±è´¥:', error);
        message('æ‹ç…§å¤±è´¥: ' + error.message);
      }
    }
    
    /** æ‰§è¡Œå¹¿è§’æ‹ç…§ */
    function performWideAngleCapture() {
      console.log('=== æ‰§è¡Œå¹¿è§’æ‹ç…§ ===');
      
      try {
        // æ£€æŸ¥è§†é¢‘çŠ¶æ€
        if (video.readyState < 2) {
          console.error('è§†é¢‘æœªå°±ç»ªï¼ŒçŠ¶æ€:', video.readyState);
          message('è§†é¢‘æœªå°±ç»ªï¼Œè¯·ç¨åé‡è¯•');
          return;
        }
        
        // åˆ›å»ºé«˜åˆ†è¾¨ç‡æ‹ç…§canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // ä½¿ç”¨æ‘„åƒå¤´çš„å®Œæ•´åŸå§‹åˆ†è¾¨ç‡
        const width = video.videoWidth;
        const height = video.videoHeight;
        
        console.log('æ‘„åƒå¤´åŸå§‹åˆ†è¾¨ç‡:', width + 'x' + height);
        console.log('å°†ä½¿ç”¨å®Œæ•´æ‘„åƒå¤´ç”»é¢è¿›è¡Œæ‹ç…§');
        
        if (!width || !height) {
          console.error('æ— æ³•è·å–æ‘„åƒå¤´åˆ†è¾¨ç‡');
          message('æ— æ³•è·å–æ‘„åƒå¤´åˆ†è¾¨ç‡');
          return;
        }
        
        // è®¾ç½®canvasä¸ºæ‘„åƒå¤´çš„å®Œæ•´åˆ†è¾¨ç‡
        canvas.width = width;
        canvas.height = height;
        
        // ç»˜åˆ¶å®Œæ•´çš„æ‘„åƒå¤´ç”»é¢åˆ°canvas
        ctx.drawImage(video, 0, 0, width, height);
        
        // éªŒè¯ç»˜åˆ¶å†…å®¹
        const imageData = ctx.getImageData(0, 0, Math.min(width, 100), Math.min(height, 100));
        const hasContent = Array.from(imageData.data).some(pixel => pixel > 0);
        
        if (!hasContent) {
          console.error('ç»˜åˆ¶çš„canvasä¸ºç©º');
          message('æ‹ç…§å¤±è´¥ï¼šæ— æ³•æ•è·å›¾åƒ');
          return;
        }
        
        console.log('å®Œæ•´æ‘„åƒå¤´ç”»é¢Canvasç»˜åˆ¶æˆåŠŸï¼Œå¼€å§‹ç”Ÿæˆbase64');
        
        // ç”Ÿæˆé«˜è´¨é‡base64å›¾ç‰‡ï¼Œä¿æŒå®Œæ•´åˆ†è¾¨ç‡
        const base64 = canvas.toDataURL('image/png', 0.95);
        
        console.log('å®Œæ•´ç”»é¢æ‹ç…§base64ç”ŸæˆæˆåŠŸï¼Œé•¿åº¦:', base64.length);
        console.log('æœ€ç»ˆå›¾ç‰‡å°ºå¯¸:', width + 'x' + height);
        
        if (base64.length < 1000) {
          console.error('Base64æ•°æ®å¼‚å¸¸çŸ­');
          message('ç”Ÿæˆå›¾ç‰‡æ•°æ®å¼‚å¸¸');
          return;
        }
        
        // æ˜¾ç¤ºå®Œæ•´ç”»é¢æ‹ç…§ç»“æœ
        displayFullResolutionPhoto(base64, width, height);
        
      } catch (error) {
        console.error('å®Œæ•´ç”»é¢æ‹ç…§è¿‡ç¨‹å‡ºé”™:', error);
        message('å®Œæ•´ç”»é¢æ‹ç…§å¤±è´¥: ' + error.message);
        
        // å¤‡ç”¨æ–¹æ¡ˆï¼šç®€åŒ–æ‹ç…§
        console.log('å°è¯•å¤‡ç”¨æ‹ç…§æ–¹æ¡ˆ');
        performSimpleFullResolutionCapture();
      }
    }
    
    /** æ˜¾ç¤ºå®Œæ•´åˆ†è¾¨ç‡æ‹ç…§ç»“æœ */
    function displayFullResolutionPhoto(base64Data, width, height) {
      console.log('=== æ˜¾ç¤ºå®Œæ•´åˆ†è¾¨ç‡æ‹ç…§ç»“æœ ===');
      
      // è·å–æˆ–åˆ›å»ºæ˜¾ç¤ºåŒºåŸŸ
      let resultDiv = document.getElementById('photo-result');
      
      if (!resultDiv) {
        console.log('åˆ›å»ºå®Œæ•´åˆ†è¾¨ç‡æ‹ç…§æ˜¾ç¤ºåŒºåŸŸ');
        resultDiv = document.createElement('div');
        resultDiv.id = 'photo-result';
        resultDiv.style.cssText = 'margin: 20px auto; padding: 20px; text-align: center; border: 2px solid #007bff; border-radius: 10px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);';
        document.body.appendChild(resultDiv);
      }
      
      // è®¡ç®—å›¾ç‰‡çš„å®½é«˜æ¯”
      const aspectRatio = width / height;
      const isLandscape = aspectRatio > 1;
      const orientation = isLandscape ? 'æ¨ªå‘' : 'çºµå‘';
      
      // è®¾ç½®å®Œæ•´åˆ†è¾¨ç‡æ‹ç…§ç»“æœHTML
      resultDiv.innerHTML = `
        <h2 style="color: #007bff; margin-bottom: 15px;">ğŸ“¸ å®Œæ•´ç”»é¢æ‹ç…§æˆåŠŸï¼</h2>
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
          <p style="margin: 5px 0; color: #2e7d32; font-weight: bold;">âœ… å¹¿è§’æ¨¡å¼ï¼šå·²å¯ç”¨</p>
          <p style="margin: 5px 0; color: #2e7d32;">ğŸ“ å®Œæ•´åˆ†è¾¨ç‡: ${width} Ã— ${height}</p>
          <p style="margin: 5px 0; color: #2e7d32;">ğŸ“± ç”»é¢æ–¹å‘: ${orientation} (${aspectRatio.toFixed(2)}:1)</p>
          <p style="margin: 5px 0; color: #2e7d32;">ğŸ” ç¼©æ”¾: æœ€å°å€¼ (æœ€å¤§è§†é‡)</p>
          <p style="margin: 5px 0; color: #2e7d32;">ğŸ¯ æ•è·: æ‘„åƒå¤´å®Œæ•´ç”»é¢</p>
        </div>
        <div style="border: 3px solid #4caf50; border-radius: 12px; padding: 10px; margin: 20px 0; background: #fff;">
          <img src="${base64Data}" style="max-width: 100%; max-height: 600px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" alt="å®Œæ•´ç”»é¢æ‹ç…§ç»“æœ" />
        </div>
        <div style="margin: 20px 0;">
          <button onclick="downloadFullResolutionPhoto()" style="padding: 15px 30px; margin: 8px; background: linear-gradient(45deg, #2196f3, #21cbf3); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 14px;">ğŸ’¾ ä¿å­˜å®Œæ•´ç…§ç‰‡</button>
          <button onclick="copyImageToClipboard()" style="padding: 15px 30px; margin: 8px; background: linear-gradient(45deg, #ff9800, #ffc107); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 14px;">ğŸ“‹ å¤åˆ¶å›¾ç‰‡</button>
          <button onclick="restartScanning()" style="padding: 15px 30px; margin: 8px; background: linear-gradient(45deg, #4caf50, #8bc34a); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 14px;">ğŸ”„ é‡æ–°æ‰«ç </button>
        </div>
        <details style="margin-top: 20px; text-align: left;">
          <summary style="cursor: pointer; color: #666; font-size: 14px; padding: 10px; background: #f5f5f5; border-radius: 5px;">ğŸ“‹ æŸ¥çœ‹Base64æ•°æ® (${Math.round(base64Data.length/1024)}KB)</summary>
          <textarea readonly style="width: 95%; height: 120px; margin-top: 10px; padding: 10px; font-size: 10px; color: #666; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">${base64Data}</textarea>
        </details>
      `;
      
      // æ˜¾ç¤ºç»“æœåŒºåŸŸ
      resultDiv.style.display = 'block';
      
      // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
      setTimeout(() => {
        resultDiv.scrollIntoView({ behavior: 'smooth' });
      }, 200);
      
      // ä¿å­˜å½“å‰å®Œæ•´åˆ†è¾¨ç‡ç…§ç‰‡æ•°æ®
      window.currentPhotoData = base64Data;
      window.currentPhotoWidth = width;
      window.currentPhotoHeight = height;
      
      message(`å®Œæ•´ç”»é¢æ‹ç…§æˆåŠŸï¼åˆ†è¾¨ç‡: ${width}Ã—${height}`);
      
      console.log('å®Œæ•´åˆ†è¾¨ç‡æ‹ç…§ç»“æœæ˜¾ç¤ºå®Œæˆ');
    }
    
    /** ä¸‹è½½å®Œæ•´åˆ†è¾¨ç‡ç…§ç‰‡ */
    function downloadFullResolutionPhoto() {
      if (window.currentPhotoData) {
        const timestamp = new Date().getTime();
        const width = window.currentPhotoWidth || 'unknown';
        const height = window.currentPhotoHeight || 'unknown';
        
        const link = document.createElement('a');
        link.href = window.currentPhotoData;
        link.download = `å¹¿è§’æ‰«ç æ‹ç…§_${width}x${height}_${timestamp}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        message(`å®Œæ•´åˆ†è¾¨ç‡ç…§ç‰‡å·²ä¿å­˜ (${width}Ã—${height})`);
      } else {
        message('æ²¡æœ‰å¯ä¿å­˜çš„å®Œæ•´åˆ†è¾¨ç‡ç…§ç‰‡');
      }
    }
    
    /** å¤‡ç”¨ç®€åŒ–å®Œæ•´åˆ†è¾¨ç‡æ‹ç…§ */
    function performSimpleFullResolutionCapture() {
      console.log('=== æ‰§è¡Œå¤‡ç”¨å®Œæ•´åˆ†è¾¨ç‡æ‹ç…§ ===');
      
      try {
        if (!video || video.readyState < 2) {
          message('è§†é¢‘æœªå°±ç»ªï¼Œæ‹ç…§å¤±è´¥');
          return;
        }
        
        // åˆ›å»ºå¤‡ç”¨canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // ä½¿ç”¨æ‘„åƒå¤´çš„å®Œæ•´åˆ†è¾¨ç‡
        const width = video.videoWidth || 640;
        const height = video.videoHeight || 480;
        
        console.log('å¤‡ç”¨æ¨¡å¼ä½¿ç”¨å®Œæ•´æ‘„åƒå¤´åˆ†è¾¨ç‡:', width + 'x' + height);
        
        canvas.width = width;
        canvas.height = height;
        
        // ç»˜åˆ¶å®Œæ•´æ‘„åƒå¤´ç”»é¢
        ctx.drawImage(video, 0, 0, width, height);
        
        // ç”Ÿæˆbase64
        const base64 = canvas.toDataURL('image/png', 0.8);
        
        if (base64 && base64.length > 1000) {
          displayFullResolutionPhoto(base64, width, height);
          console.log('å¤‡ç”¨å®Œæ•´åˆ†è¾¨ç‡æ‹ç…§æˆåŠŸ');
        } else {
          message('å¤‡ç”¨æ‹ç…§ä¹Ÿå¤±è´¥');
        }
        
      } catch (error) {
        console.error('å¤‡ç”¨æ‹ç…§å¤±è´¥:', error);
        message('æ‰€æœ‰æ‹ç…§æ–¹æ¡ˆéƒ½å¤±è´¥');
      }
    }
    
    /** é‡æ–°å¼€å§‹æ‰«æ */
    function restartScanning() {
      const resultDiv = document.getElementById('photo-result');
      if (resultDiv) {
        resultDiv.style.display = 'none';
      }
      window.currentPhotoData = null;
      window.currentPhotoWidth = null;
      window.currentPhotoHeight = null;
      startScan();
    }
    




    /** éšè—æ‹ç…§ç»“æœ */
    function hidePhotoResult() {
      document.getElementById('photo-result').style.display = 'none';
    }

    /** ä¸‹è½½ç…§ç‰‡ */
    function downloadPhoto() {
      const base64Data = document.getElementById('base64-output').value;
      if (!base64Data) {
        message('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡');
        return;
      }
      
      // åˆ›å»ºä¸‹è½½é“¾æ¥
      const link = document.createElement('a');
      link.href = base64Data;
      link.download = `æ‰«ç æ‹ç…§_${new Date().getTime()}.png`;
      
      // è§¦å‘ä¸‹è½½
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      message('å›¾ç‰‡å·²ä¿å­˜');
    }

    /** éªŒè¯äºŒç»´ç æ–‡æœ¬, æ»¡è¶³æ¡ä»¶çš„æ‰ä¼šè¢«æ‰«æ */
    function validateQRCodeText(decodedText) {
      // return decodedText.startsWith('https://act.juhyb.com')
      return decodedText.startsWith('https:')
    }

    function drawLine(begin, end, color) {
      canvasCtx.beginPath();
      canvasCtx.moveTo(begin.x, begin.y);
      canvasCtx.lineTo(end.x, end.y);
      canvasCtx.lineWidth = 8;
      canvasCtx.strokeStyle = color;
      canvasCtx.stroke();
    }

    function stopScan() {
      isScanning = false
      
      if (stream) {
        // éå†æµä¸­çš„æ‰€æœ‰è½¨é“
        stream.getTracks().forEach(track => {
          // åœæ­¢æ¯ä¸ªè½¨é“
          track.stop();
        });
        stream = null
      }
      if (video) {
        // åœæ­¢è§†é¢‘
        video.pause()
        video.removeAttribute('src')
        video.load()
        video = null
      }
      // canvasCtx.clearRect(0, 0, canvasEle.width, canvasEle.height)
      document.querySelector('.reader-wrap').style.display = 'none'
    }


    const msgEle = document.querySelector('.outputMessage')
    let msgTimer = null
    function message(msg) {
      msgEle.textContent = msg
      msgEle.style.display = 'block'
      if (msgTimer) {
        clearTimeout(msgTimer)
      }
      msgTimer = setTimeout(() => {
        clearMessage()
      }, 2000)
    }
    function clearMessage() {
      msgEle.textContent = ''
      msgEle.style.display = 'none'
    }

    function showLoading() {
      document.querySelector('.loading-wrap').style.display = 'flex'
    }
    function hideLoading() {
      document.querySelector('.loading-wrap').style.display = 'none'
    }


  </script>
</body>

</html>