<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover"
  />
  <title>Document</title>
  <script src="./jsQR.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="./scan.css">
</head>

<body>
  <button id="start-btn">开始扫描9</button>
  
  <!-- 拍照结果显示区域 -->
  <div class="photo-result" id="photo-result" style="display: none;">
    <h3>拍照结果</h3>
    <img id="captured-image" style="max-width: 100%; height: auto; border: 1px solid #ccc;" />
    <div class="base64-output">
      <h4>Base64数据:</h4>
      <textarea id="base64-text" readonly style="width: 100%; height: 100px; margin-top: 10px;"></textarea>
    </div>
    <button id="retry-btn">重新扫描</button>
  </div>

  <div class="reader-wrap">
    <div style="position: relative;width: 160px;height: 160px;">
      <canvas id="reader-canvas">
      </canvas>
      <div class="scan-box">
        <div class="line"></div>
        <div class="angle"></div>
      </div>
      <div class="loading-wrap">
        <svg class="circular" viewBox="0 0 20 20">
          <g class="path2 loading-path" stroke-width="0" style="animation: none; stroke: none">
            <circle r="3.375" class="dot1" rx="0" ry="0" />
            <circle r="3.375" class="dot2" rx="0" ry="0" />
            <circle r="3.375" class="dot4" rx="0" ry="0" />
            <circle r="3.375" class="dot3" rx="0" ry="0" />
          </g>
        </svg>
        <div>正在初始化...</div>
      </div>
      <div class="outputMessage"></div>
    </div>
  </div>

  <script>
    const canvasEle = document.querySelector('#reader-canvas')
    const canvasCtx = canvasEle.getContext('2d', {
      willReadFrequently: true,
    })
    let stream = null
    let video = null
    let photoStream = null
    let photoVideo = null
    /** 二维码面积占比限制, 只有占比小于这个值的二维码才会被扫描， 最大值为1 */
    const RatioLimit = 0.03

    document.getElementById('start-btn').addEventListener('click', () => {
      startScan()
    })
    
    document.getElementById('retry-btn').addEventListener('click', () => {
      document.getElementById('photo-result').style.display = 'none'
      startScan()
    })

    /** 初始化 */
    function startScan() {
      video = document.createElement("video");

      // 显示加载中动画
      showLoading()

      document.querySelector('.reader-wrap').style.display = 'flex'
      const stream = navigator.mediaDevices.getUserMedia({
        audio: false, // 不需要音频
        video: {
          focusMode: "continuous", // 自动调焦模式
          // 明确指定使用后置摄像头
          facingMode: { exact: "environment" },
          width: 800,
          height: 800,
        }
      }).then(function (videoStream) {
        video.srcObject = videoStream;

        // 获取视频轨道
        const track = videoStream.getVideoTracks()[0];

        const capabilities = track.getCapabilities();
        if (capabilities.zoom) {
          // 获取当前变焦值
          const zoom = track.getSettings().zoom;
          // 设置新的变焦值
          track.applyConstraints({ advanced: [{ zoom: {
            min: 2,
            ideal: 3,
            max: 3.5
          } }] })
            .then(() => {
              console.log('变焦已成功');
            })
            .catch(e => {
              console.error('设置变焦失败:', e);
            });
        } else {
          console.log('该设备不支持变焦功能。');
        }

        // 让 safari 浏览器不进入全屏
        video.setAttribute("playsinline", true);
        video.setAttribute('webkit-playsinline', 'true');

        video.play();
        requestAnimationFrame(renderVideo);
        hideLoading()
      })
        .catch(err => {
          console.error(err)
          // 如果严格后置摄像头模式失败，尝试普通后置摄像头设置
          if (err.name === 'OverconstrainedError' || err.name === 'NotFoundError') {
            console.log('严格后置摄像头模式失败，尝试普通后置摄像头模式')
            return navigator.mediaDevices.getUserMedia({
              audio: false,
              video: {
                focusMode: "continuous",
                facingMode: "environment", // 普通后置摄像头设置
                width: 800,
                height: 800,
              }
            }).then(function (videoStream) {
              video.srcObject = videoStream;
              
              const track = videoStream.getVideoTracks()[0];
              const capabilities = track.getCapabilities();
              if (capabilities.zoom) {
                track.applyConstraints({ advanced: [{ zoom: {
                  min: 2,
                  ideal: 3,
                  max: 3.5
                } }] })
                  .then(() => {
                    console.log('变焦已成功');
                  })
                  .catch(e => {
                    console.error('设置变焦失败:', e);
                  });
              } else {
                console.log('该设备不支持变焦功能。');
              }
              
              video.setAttribute("playsinline", true);
              video.setAttribute('webkit-playsinline', 'true');
              video.play();
              requestAnimationFrame(renderVideo);
              hideLoading()
            })
          }
          
          message('您需要授予相机访问权限')
        })
    }

    /** 扫描成功回调 */
    function onScanSuccess(decodedText, ratio) {
      console.log(ratio)
      if (ratio > RatioLimit) {
        message('请离远一点')
        return
      }
      clearMessage()
      // message('扫码成功，正在启动广角拍照...')
      stopScan()
      // 立即启动拍照
      startWideAnglePhotoAndInstantCapture()
    }

    function detectQRCodeFn() {
      const imageData = canvasCtx.getImageData(0, 0, canvasEle.width, canvasEle.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code) {
        // 绘制边框
        drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
        drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");

        if (!validateQRCodeText(code.data)) {
          message('无效的二维码')
          return
        }

        const loc = code.location;
        // 使用 Shoelace 公式计算任意四边形面积，更精确
        const qrArea = 0.5 * Math.abs(
          loc.topLeftCorner.x * loc.topRightCorner.y - loc.topLeftCorner.y * loc.topRightCorner.x +
          loc.topRightCorner.x * loc.bottomRightCorner.y - loc.topRightCorner.y * loc.bottomRightCorner.x +
          loc.bottomRightCorner.x * loc.bottomLeftCorner.y - loc.bottomRightCorner.y * loc.bottomLeftCorner.x +
          loc.bottomLeftCorner.x * loc.topLeftCorner.y - loc.bottomLeftCorner.y * loc.topLeftCorner.x
        );

        const imageArea = canvasEle.width * canvasEle.height;
        const ratio = qrArea / imageArea;
        onScanSuccess(code.data, ratio)
      }
    }

    // 渲染视频到 canvas
    function renderVideo() {
      if (video && video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasEle.height = video.videoHeight;
        canvasEle.width = video.videoWidth;
        canvasCtx.drawImage(video, 0, 0, canvasEle.width, canvasEle.height);
        detectQRCodeFn()
      }
      requestAnimationFrame(renderVideo);
    }

    /** 上传截图到后端 */
    function uploadScreenshot() {
      canvasEle.toBlob((blob) => {
        // 检查是否成功生成 Blob
        if (blob) {
          // 创建 FormData 对象
          const formData = new FormData();

          // 将 Blob 对象添加到 FormData 中，第一个参数是字段名（服务器用来接收），第二个是 Blob 对象
          formData.append('screenshot', blob, 'canvas_screenshot.png');

          // TODO 使用 fetch 或 ajax 发送 POST 请求, 把 formData 发给后端
          // console.log(formData)
          message('截图已成功上传！')
        } else {
          console.error('无法生成 Canvas Blob。');
        }
      }, 'image/png', 0.9); // 指定图片格式为 PNG，质量为 0.9
    }

    /** 验证二维码文本, 满足条件的才会被扫描 */
    function validateQRCodeText(decodedText) {
      // return decodedText.startsWith('https://act.juhyb.com')
      return decodedText.startsWith('https://')


    }

    function drawLine(begin, end, color) {
      canvasCtx.beginPath();
      canvasCtx.moveTo(begin.x, begin.y);
      canvasCtx.lineTo(end.x, end.y);
      canvasCtx.lineWidth = 8;
      canvasCtx.strokeStyle = color;
      canvasCtx.stroke();
    }

    function stopScan() {
      if (stream) {
        // 遍历流中的所有轨道
        stream.getTracks().forEach(track => {
          // 停止每个轨道
          track.stop();
        });
        stream = null
      }
      if (video) {
        // 停止视频
        video.pause()
        video.removeAttribute('src')
        video.load()
        video = null
      }
      // canvasCtx.clearRect(0, 0, canvasEle.width, canvasEle.height)
      document.querySelector('.reader-wrap').style.display = 'none'
    }
    
    /** 启动广角拍照模式并立即拍照 */
    function startWideAnglePhotoAndInstantCapture() {
      photoVideo = document.createElement("video");
      
      // 显示拍照界面
      document.querySelector('.reader-wrap').style.display = 'flex'
      showLoading()
      
      navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {
          // 明确指定使用后置摄像头
          facingMode: { exact: "environment" },
          // 使用4K分辨率获得最高质量
          width: { ideal: 3840, min: 1920 },
          height: { ideal: 2160, min: 1080 },
          // 广角模式设置
          zoom: { ideal: 1 }, // 最小缩放，获得最广角度
          focusMode: "continuous"
        }
      }).then(function (videoStream) {
        photoStream = videoStream
        photoVideo.srcObject = videoStream;
        
        // 获取视频轨道并设置广角
        const track = videoStream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        
        // 设置为广角模式（最小缩放）
        if (capabilities.zoom) {
          track.applyConstraints({ 
            advanced: [{ 
              zoom: { ideal: capabilities.zoom.min || 1 } 
            }] 
          }).then(() => {
            console.log('已设置为广角模式');
          }).catch(e => {
            console.error('设置广角模式失败:', e);
          });
        }
        
        photoVideo.setAttribute("playsinline", true);
        photoVideo.setAttribute('webkit-playsinline', 'true');
        photoVideo.play();
        
        hideLoading()
        
        // 等待视频准备好后立即拍照
        photoVideo.addEventListener('loadeddata', () => {
          // 短暂延迟确保视频完全准备好
          setTimeout(() => {
            autoCapture()
          }, 300)
        })
        
        // 开始渲染拍照预览
        requestAnimationFrame(renderPhotoPreview)
        
      }).catch(err => {
        console.error(err)
        // 如果严格要求后置摄像头失败，尝试普通后置摄像头设置
        if (err.name === 'OverconstrainedError' || err.name === 'NotFoundError') {
          console.log('严格后置摄像头模式失败，尝试普通后置摄像头模式')
          return navigator.mediaDevices.getUserMedia({
            audio: false,
            video: {
              facingMode: "environment", // 普通后置摄像头设置
              width: { ideal: 3840, min: 1920 },
              height: { ideal: 2160, min: 1080 },
              zoom: { ideal: 1 },
              focusMode: "continuous"
            }
          }).then(function (videoStream) {
            console.log('使用普通后置摄像头模式成功')
            // 相同的处理逻辑
            photoStream = videoStream
            photoVideo.srcObject = videoStream;
            
            const track = videoStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            
            if (capabilities.zoom) {
              track.applyConstraints({ 
                advanced: [{ 
                  zoom: { ideal: capabilities.zoom.min || 1 } 
                }] 
              }).then(() => {
                console.log('已设置为广角模式');
              }).catch(e => {
                console.error('设置广角模式失败:', e);
              });
            }
            
            photoVideo.setAttribute("playsinline", true);
            photoVideo.setAttribute('webkit-playsinline', 'true');
            photoVideo.play();
            
            hideLoading()
            
            photoVideo.addEventListener('loadeddata', () => {
              setTimeout(() => {
                autoCapture()
              }, 300)
            })
            
            requestAnimationFrame(renderPhotoPreview)
          })
        }
        
        message('启动广角拍照失败，请重试')
        hideLoading()
      })
    }
    

    
    /** 渲染拍照预览 */
    function renderPhotoPreview() {
      if (photoVideo && photoVideo.readyState === photoVideo.HAVE_ENOUGH_DATA) {
        canvasEle.height = photoVideo.videoHeight;
        canvasEle.width = photoVideo.videoWidth;
        canvasCtx.drawImage(photoVideo, 0, 0, canvasEle.width, canvasEle.height);
      }
      if (photoVideo) {
        requestAnimationFrame(renderPhotoPreview);
      }
    }
    
    /** 自动拍照功能 */
    function autoCapture() {
      if (!photoVideo || photoVideo.readyState !== photoVideo.HAVE_ENOUGH_DATA) {
        message('相机未准备好，正在重试...')
        // 等待一下再重试
        setTimeout(() => {
          if (photoVideo) {
            autoCapture()
          }
        }, 500)
        return
      }
      
      // 创建一个新的canvas来生成高质量照片
      const photoCanvas = document.createElement('canvas')
      const photoCtx = photoCanvas.getContext('2d')
      
      // 设置照片尺寸
      photoCanvas.width = photoVideo.videoWidth
      photoCanvas.height = photoVideo.videoHeight
      
      // 绘制当前帧到照片canvas
      photoCtx.drawImage(photoVideo, 0, 0, photoCanvas.width, photoCanvas.height)
      
      // 转换为base64
      const base64Data = photoCanvas.toDataURL('image/jpeg', 0.9)
      
      // 停止拍照流
      stopPhotoStream()
      
      // 显示拍照结果
      displayPhotoResult(base64Data)
      
      message('拍照成功！正在处理图片...')
      
      // 延迟一下显示完成信息
      setTimeout(() => {
        message('处理完成！')
      }, 1000)
    }
    
    /** 停止拍照流 */
    function stopPhotoStream() {
      if (photoStream) {
        photoStream.getTracks().forEach(track => {
          track.stop();
        });
        photoStream = null
      }
      if (photoVideo) {
        photoVideo.pause()
        photoVideo.removeAttribute('src')
        photoVideo.load()
        photoVideo = null
      }
      
      document.querySelector('.reader-wrap').style.display = 'none'
    }
    
    /** 显示拍照结果 */
    function displayPhotoResult(base64Data) {
      // 显示图片
      const capturedImage = document.getElementById('captured-image')
      capturedImage.src = base64Data
      
      // 显示base64数据
      const base64Text = document.getElementById('base64-text')
      base64Text.value = base64Data
      
      // 显示结果区域
      document.getElementById('photo-result').style.display = 'block'
      
      clearMessage()
    }


    const msgEle = document.querySelector('.outputMessage')
    let msgTimer = null
    function message(msg) {
      msgEle.textContent = msg
      msgEle.style.display = 'block'
      if (msgTimer) {
        clearTimeout(msgTimer)
      }
      msgTimer = setTimeout(() => {
        clearMessage()
      }, 2000)
    }
    function clearMessage() {
      msgEle.textContent = ''
      msgEle.style.display = 'none'
    }

    function showLoading() {
      document.querySelector('.loading-wrap').style.display = 'flex'
    }
    function hideLoading() {
      document.querySelector('.loading-wrap').style.display = 'none'
    }

    /** 截图并下载 */
    function takeScreenshot() {
      const imageURL = canvasEle.toDataURL('image/png')

      // 创建一个临时的 <a> 元素来触发下载
      const a = document.createElement('a');
      a.href = imageURL;
      a.download = 'my-canvas-image.png'; // 设置下载的文件名

      // 模拟点击这个链接
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>

</html>