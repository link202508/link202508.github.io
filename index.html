<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover"
  />
  <title>Document</title>
  <script src="./jsQR.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="./scan.css">
</head>

<body>
  <button id="start-btn">开始扫描5</button>

  <div class="reader-wrap">
    <div style="position: relative;width: 160px;height: 160px;">
      <canvas id="reader-canvas">
      </canvas>
      <div class="scan-box">
        <div class="line"></div>
        <div class="angle"></div>
      </div>
      <div class="loading-wrap">
        <svg class="circular" viewBox="0 0 20 20">
          <g class="path2 loading-path" stroke-width="0" style="animation: none; stroke: none">
            <circle r="3.375" class="dot1" rx="0" ry="0" />
            <circle r="3.375" class="dot2" rx="0" ry="0" />
            <circle r="3.375" class="dot4" rx="0" ry="0" />
            <circle r="3.375" class="dot3" rx="0" ry="0" />
          </g>
        </svg>
        <div>正在初始化...</div>
      </div>
      <div class="outputMessage"></div>
    </div>
  </div>

  <script>
    // 检查jsQR库是否正确加载
    if (typeof jsQR === 'undefined') {
      console.error('jsQR库未正确加载！');
      alert('jsQR库未正确加载，请检查文件路径！');
    } else {
      console.log('jsQR库加载成功');
    }
    
    const canvasEle = document.querySelector('#reader-canvas')
    const canvasCtx = canvasEle.getContext('2d', {
      willReadFrequently: true,
    })
    let stream = null
    let video = null
    let isScanning = true // 添加扫描状态控制
    /** 二维码面积占比限制, 只有占比小于这个值的二维码才会被扫描， 最大值为1 */
    const RatioLimit = 0.03

    document.getElementById('start-btn').addEventListener('click', () => {
      startScan()
    })

    /** 初始化 */
    function startScan() {
      isScanning = true // 重置扫描状态
      video = document.createElement("video");

      // 显示加载中动画
      showLoading()

      document.querySelector('.reader-wrap').style.display = 'flex'
      stream = navigator.mediaDevices.getUserMedia({
        audio: false, // 不需要音频
        video: {
          focusMode: "continuous", // 自动调焦模式
          facingMode: "environment",
          width: { ideal: 1920, max: 1920 },
          height: { ideal: 1080, max: 1080 },
          // 广角模式配置
          advanced: [{
            aspectRatio: { ideal: 16/9 },
            frameRate: { ideal: 30, max: 30 },
            // 如果设备支持，请求更宽的视野角度
            zoom: { ideal: 0.5, min: 0.3, max: 1.0 }
          }]
        }
      }).then(function (videoStream) {
        video.srcObject = videoStream;

        // 获取视频轨道
        const track = videoStream.getVideoTracks()[0];

        const capabilities = track.getCapabilities();
        if (capabilities.zoom) {
          // 获取当前变焦值
          const zoom = track.getSettings().zoom;
          // 设置广角模式的变焦值（更小的值可以获得更大的视野）
          track.applyConstraints({ advanced: [{ zoom: {
            min: 0.3,
            ideal: 0.5,
            max: 1.0
          } }] })
            .then(() => {
              console.log('广角模式设置成功');
            })
            .catch(e => {
              console.error('设置广角模式失败:', e);
            });
        } else {
          console.log('该设备不支持变焦功能。');
        }

        // 让 safari 浏览器不进入全屏
        video.setAttribute("playsinline", true);
        video.setAttribute('webkit-playsinline', 'true');

        video.play();
        console.log('视频开始播放，启动渲染循环');
        requestAnimationFrame(renderVideo);
        hideLoading()
      })
        .catch(err => {
          console.error(err)
          message('您需要授予相机访问权限')
        })
    }

    /** 扫描成功回调 */
    function onScanSuccess(decodedText, ratio) {
      if (!isScanning) {
        return // 如果已经停止扫描，则不处理
      }
      
      console.log('扫描成功回调被调用, ratio:', ratio)
      
      if (ratio > RatioLimit) {
        message('请离远一点')
        return
      }
      
      isScanning = false // 设置为停止扫描状态
      clearMessage()
      
      // 显示扫码成功提示
      message('扫码成功！正在拍照...')
      console.log('扫码成功！解码内容:', decodedText)
      
      // 延迟一下再拍照，让用户看到成功提示
      setTimeout(() => {
        takePhoto() // 改为拍照功能
        stopScan()
      }, 500)
    }

    function detectQRCodeFn() {
      if (!isScanning) {
        return // 如果已经停止扫描，则不检测
      }
      
      const imageData = canvasCtx.getImageData(0, 0, canvasEle.width, canvasEle.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code) {
        console.log('检测到二维码:', code.data); // 添加调试信息
        
        // 绘制边框
        drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
        drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");

        if (!validateQRCodeText(code.data)) {
          message('无效的二维码')
          return
        }
        
        const loc = code.location;
        // 使用 Shoelace 公式计算任意四边形面积，更精确
        const qrArea = 0.5 * Math.abs(
          loc.topLeftCorner.x * loc.topRightCorner.y - loc.topLeftCorner.y * loc.topRightCorner.x +
          loc.topRightCorner.x * loc.bottomRightCorner.y - loc.topRightCorner.y * loc.bottomRightCorner.x +
          loc.bottomRightCorner.x * loc.bottomLeftCorner.y - loc.bottomRightCorner.y * loc.bottomLeftCorner.x +
          loc.bottomLeftCorner.x * loc.topLeftCorner.y - loc.bottomLeftCorner.y * loc.topLeftCorner.x
        );

        const imageArea = canvasEle.width * canvasEle.height;
        const ratio = qrArea / imageArea;
        onScanSuccess(code.data, ratio)
      }
    }

    // 渲染视频到 canvas
    function renderVideo() {
      if (video && video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasEle.height = video.videoHeight;
        canvasEle.width = video.videoWidth;
        canvasCtx.drawImage(video, 0, 0, canvasEle.width, canvasEle.height);
        detectQRCodeFn()
      } else {
        // 调试信息：视频未准备好
        console.log('视频未准备好, readyState:', video ? video.readyState : 'video is null');
      }
      if (isScanning) { // 只有在扫描状态下才继续渲染
        requestAnimationFrame(renderVideo);
      }
    }

    /** 拍照功能（广角模式）并生成base64 */
    function takePhoto() {
      if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) {
        message('摄像头未准备好')
        return
      }

      // 创建一个临时canvas用于拍照
      const photoCanvas = document.createElement('canvas')
      const photoCtx = photoCanvas.getContext('2d')
      
      // 设置拍照尺寸（保持广角模式的高分辨率）
      photoCanvas.width = video.videoWidth
      photoCanvas.height = video.videoHeight
      
      // 从视频流中捕获当前帧
      photoCtx.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height)
      
      // 生成base64格式的图片
      const base64Image = photoCanvas.toDataURL('image/jpeg', 0.9) // 使用JPEG格式，质量0.9
      
      console.log('拍照成功，base64格式:')
      console.log(base64Image)
      
      // TODO: 在这里处理base64图片数据
      // 例如：上传到服务器、保存到本地存储等
      
      message(`扫码成功！拍照完成！图片尺寸: ${photoCanvas.width}x${photoCanvas.height}`, 4000)
      
      // 可选：显示拍照的图片给用户预览
      showPhotoPreview(base64Image)
      
      return base64Image
    }

    /** 显示拍照预览（可选功能） */
    function showPhotoPreview(base64Image) {
      // 创建预览图片元素
      const previewImg = document.createElement('img')
      previewImg.src = base64Image
      previewImg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 80vw;
        max-height: 80vh;
        border: 2px solid #FF3B58;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        z-index: 10000;
        background: white;
      `
      
      // 创建遮罩层
      const overlay = document.createElement('div')
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        cursor: pointer;
      `
      
      // 点击遮罩层关闭预览
      overlay.onclick = () => {
        document.body.removeChild(overlay)
        document.body.removeChild(previewImg)
      }
      
      // 显示预览
      document.body.appendChild(overlay)
      document.body.appendChild(previewImg)
      
      // 3秒后自动关闭
      setTimeout(() => {
        if (document.body.contains(overlay)) {
          document.body.removeChild(overlay)
          document.body.removeChild(previewImg)
        }
      }, 3000)
    }

    /** 验证二维码文本, 满足条件的才会被扫描 */
    function validateQRCodeText(decodedText) {
      return decodedText.startsWith('https://act.juhyb.com')
    }

    function drawLine(begin, end, color) {
      canvasCtx.beginPath();
      canvasCtx.moveTo(begin.x, begin.y);
      canvasCtx.lineTo(end.x, end.y);
      canvasCtx.lineWidth = 8;
      canvasCtx.strokeStyle = color;
      canvasCtx.stroke();
    }

    function stopScan() {
      if (stream) {
        // 遍历流中的所有轨道
        stream.getTracks().forEach(track => {
          // 停止每个轨道
          track.stop();
        });
      }
      if (video) {
        // 停止视频
        video.pause()
        video.removeAttribute('src')
        video.load()
        video = null
      }
      // canvasCtx.clearRect(0, 0, canvasEle.width, canvasEle.height)
      document.querySelector('.reader-wrap').style.display = 'none'
    }


    const msgEle = document.querySelector('.outputMessage')
    let msgTimer = null
    function message(msg, duration = 3000) {
      msgEle.textContent = msg
      msgEle.style.display = 'block'
      if (msgTimer) {
        clearTimeout(msgTimer)
      }
      msgTimer = setTimeout(() => {
        clearMessage()
      }, duration)
    }
    function clearMessage() {
      msgEle.textContent = ''
      msgEle.style.display = 'none'
    }

    function showLoading() {
      document.querySelector('.loading-wrap').style.display = 'flex'
    }
    function hideLoading() {
      document.querySelector('.loading-wrap').style.display = 'none'
    }

    /** 截图并下载 */
    function takeScreenshot() {
      const imageURL = canvasEle.toDataURL('image/png')

      // 创建一个临时的 <a> 元素来触发下载
      const a = document.createElement('a');
      a.href = imageURL;
      a.download = 'my-canvas-image.png'; // 设置下载的文件名

      // 模拟点击这个链接
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>

</html>